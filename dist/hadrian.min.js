"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=async(e,t,n,s)=>n(s||new Error("Server Error")),t=()=>({name:"default",useSessions:!1,deserializeTactic:"always",clientType:"client",selfInit:!1,extract:"body",getUser:async()=>({}),verify:async()=>!0,serialize:async e=>e,deserialize:async e=>e,initOnError:e,initOnSuccess:null,authenticateOnError:e,authenticateOnFail:{status:401},authenticateOnSuccess:null,checkAuthenticationOnFail:{status:401},checkAuthenticationOnSuccess:null,checkAuthenticatedOnFail:{status:401},checkAuthenticatedOnSuccess:null,checkUnauthenticatedOnFail:{status:401},checkUnauthenticatedOnSuccess:null,logoutOnSuccess:null,deserializeUserOnError:e,serializeUserOnError:e,deserializeUserOnSuccess:null}),n={_default:t()},s=e=>(t,n)=>n.sendStatus(e),r=(e,t)=>{if("function"==typeof e)return e;if("object"!=typeof e)throw new Error(`Invalid ${t} input, type ${typeof e} - ${e}`);if(e.redirect)return n=e.redirect,(r=e.status)?(e,t)=>t.status(r).redirect(n):(e,t)=>t.redirect(n);var n,r;if(e.send)return((e,t)=>t?(n,s)=>s.status(t).send(e):(t,n)=>n.send(e))(e.send,e.status);if(e.json)return((e,t)=>t?(n,s)=>s.status(t).json(e):(t,n)=>n.json(e))(e.json,e.status);if(e.render)return((e,t,n={})=>t?(s,r)=>r.status(t).render(e,n):(t,s)=>s.render(e,n))(e.render,e.status,e.renderData);if(e.status)return s(e.status);if(e.sendStatus)return s(e.sendStatus);throw new Error(`Invalid ${t} input`)},i=(e,t,s)=>{const r=((e,t)=>{if(e&&!n[e])throw new Error("model is not set");return{...n[e||"_default"],...t}})(e,t);return((e,t)=>{e.onFail&&(e[t+"OnFail"]=e.onFail),e.onError&&(e[t+"OnError"]=e.onError),e.onSuccess&&(e[t+"OnSuccess"]=e.onSuccess)})(r,s),(e=>{if("function"!=typeof e.verify)throw new Error("verify must be a function");if("function"!=typeof e.getUser)throw new Error("getUser must be a function")})(r),r},a=async(e,t)=>async function(){if(this.deserializedUser)return this.deserializedUser;const e=t(this.hadrian.user);return this.deserializedUser=e,e},c=()=>function(){return Promise.resolve(this.deserializedUser)},u=async(e,t,n)=>{const s=await t(e);return n.deserializedUser=s,s},o=e=>e,d=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=i(e,t,"init");if(!n.useSessions)return(e=>{if(e.initOnSuccess){const t=r(e.initOnSuccess,"initOnSuccess");return(e,n,s)=>{e.hadrian={isAuthenticated:!1},t(e,n,s)}}return(e,t,n)=>{e.hadrian={isAuthenticated:!1,auth:{}},n()}})(n);const{deserialize:s}=n,c=r(n.initOnError,"initOnError"),o="always"===n.deserializeTactic?u:a,d=(e,t,n)=>{e.session.hadrian?(e.hadrian=e.session.hadrian,e.deserializedUser=null,e.hadrian.user?o(e.hadrian.user,s,e).then(t=>{e.user=t,n()}).catch(s=>{c(e,t,n,s)}):n()):(e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n())};return n.initOnSuccess?[d,r(n.initOnSuccess,"initOnSuccess")]:d};class l extends Error{constructor(e){super(e),this.name="ValidationError",this.reason=e,this.isFail=!0}}exports.Fail=l,exports.authenticate=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=i(e,t,"authenticate"),{verify:s,getUser:a,clientType:u,name:l}=n,h=(e=>"function"==typeof e?e:t=>t[e])(n.extract),f=r(n.authenticateOnError,"authenticateOnError"),O=r(n.authenticateOnFail,"authenticateOnFail"),y="always"===n.deserializeTactic?o:c,p=(e,t,n)=>{(async()=>{const r=await h(e),i=await a(r,e),c=await s(r,i,e);if(!c)return O(e,t,n);e.hadrian.auth[l]={clientType:u,query:r,model:l,result:c},e.hadrian.isAuthenticated=!0,e.deserializedUser=i,e.user=y(i,e),n()})().catch(s=>{if(s.isFail)return O(e,t,n,s);f(e,t,n,s)})},S=[];return n.selfInit&&S.push(d(n)),S.push(p),n.useSessions&&S.push((e=>{const{serialize:t,serializeOnError:n}=e;return(e,s,r)=>{(async()=>{const n=await t(e.deserializedUser);e.hadrian.user=n,e.session.hadrian=e.hadrian,r()})().catch(t=>n(e,s,r,t))}})(n)),n.authenticateOnSuccess&&S.push(r(n.authenticateOnSuccess,"authenticateOnSuccess")),1===S.length?p:S},exports.checkAuthenticated=(e,t)=>((e,t,n)=>{"object"==typeof e&&(t=e,e=null);const s=n+"OnFail",a=n+"OnSuccess",c=i(e,t,n),u=r(c[s],s);if(!c[a])return(e,t,n)=>{if(e.hadrian.isAuthenticated)return n();u(e,t)};const o=r(c[a],a);return(e,t,n)=>{if(e.hadrian.isAuthenticated)return o(e,t,n);u(e,t)}})(e,t,"checkAuthenticated"),exports.checkUnauthenticated=(e,t)=>((e,t,n)=>{"object"==typeof e&&(t=e,e=null);const s=n+"OnFail",a=n+"OnSuccess",c=i(e,t,n),u=r(c[s],s);if(!c[a])return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return n();u(e,t)};const o=r(c[a],a);return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return o(e,t,n);u(e,t)}})(e,t,"checkUnauthenticated"),exports.defineModel=(e,s,r)=>{if("object"==typeof e){if(r=s,!(s=e).name)throw new Error("Model must have a name");e=e.name}n[e]={...t(),...s},n[e].name=e,n[e].isDefault=r,r&&(n._default=n[e])},exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=i(e,t,"deserializeUser"),s=r(n.deserializeUserOnError,"deserializeUserOnError"),a=(e,t,n)=>{if(!e.user)return n();e.user().then(()=>{n()}).catch(r=>{s(e,t,n,r)})};return n.deserializeUserOnSuccess?[a,r(n.deserializeUserOnSuccess,"deserializeUserOnSuccess")]:a},exports.init=d,exports.initialize=d,exports.logout=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=i(e,t,"logout");if(!n.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const s=(e,t,n)=>{delete e.user,e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n()};return n.logoutOnSuccess?[s,r(n.logoutOnSuccess,"logoutOnSuccess")]:s},exports.models=n,exports.modifyModel=(e,t)=>{if(!n[e])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:s}=n[e];Object.assign(n[e],t),n[e].isDefault=s};
