"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=(e,t,n,s)=>n(s||new Error("Server Error")),t={sendStatus:401},n={name:{type:["string"],default:"_default"},clientType:{type:["string"],default:"client"},isDefault:{type:["boolean","undefined"],default:!1},sessions:{type:"child",children:{useSessions:{type:["boolean"],default:!1},deserializeTactic:{type:["string"],default:"always"},serialize:{type:["function"],default:e=>e},deserialize:{type:["function"],default:e=>e}}},authenticate:{type:"child",children:{extract:{type:["string","function"],default:"body"},getData:{type:["function"],default:()=>({})},verify:{type:["function"],default:()=>!0},setUser:{type:["function"],default:(e,t)=>t},onError:{type:["null","function","object"],default:e},onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null},selfInit:{type:["boolean"],default:!1}}},init:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}},checkAuthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},checkUnauthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},logout:{type:"child",children:{onSuccess:{type:["null","function","object"],default:null}}},deserializeUser:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}}},s=e=>{const t=typeof e;return"object"!==t?t:null===e?"null":Array.isArray(e)?"array":"object"},i=e=>"object"===s(e),r=(e,t)=>e.type.includes(s(t)),a=e=>{const t=(e,n)=>(Object.keys(e).forEach(i=>{if("child"===e[i].type)n[i]={},t(e[i].children,n[i]);else{if(!r(e[i],e[i].default))throw new Error(`${i} must be of the following type/s: ${e[i].type} is of type ${s(e[i].default)})}`);n[i]=e[i].default}}),n);return t(e,{})},o=(e,t)=>(Object.keys(t).forEach(n=>{if(void 0===e[n])throw new Error("Unknown option "+n);if(i(e[n])&&"child"===e[n].type)o(e[n].children,t[n]);else if(!r(e[n],t[n]))throw new Error(`${n} must be of the following type/s: ${e[n].type} is of type ${s(t[n])})}`)}),!0),c=e=>((e,t)=>{const n=(e,t,a)=>(Object.keys(t).forEach(o=>{if(void 0===e[o])throw new Error("Unknown option "+o);if(i(e[o])&&"child"===e[o].type)n(e[o].children,t[o],a[o]);else{if(!r(e[o],t[o]))throw new Error(`${o} must be of the following type/s: ${e[o].type} is of type ${s(t[o])})}`);a[o]=t[o]}}),a);return n(e,t,a(e))})(n,e),u={_default:a(n)},l=e=>(t,n)=>n.sendStatus(e),d=(e,t)=>{if("function"==typeof e)return e;if("object"!=typeof e)throw new Error(`Invalid ${t} input, type ${typeof e} - ${e}`);if(e.redirect)return n=e.redirect,(s=e.status)?(e,t)=>t.status(s).redirect(n):(e,t)=>t.redirect(n);var n,s;if(e.send)return((e,t)=>t?(n,s)=>s.status(t).send(e):(t,n)=>n.send(e))(e.send,e.status);if(e.json)return((e,t)=>t?(n,s)=>s.status(t).json(e):(t,n)=>n.json(e))(e.json,e.status);if(e.render)return((e,t,n={})=>t?(s,i)=>i.status(t).render(e,n):(t,s)=>s.render(e,n))(e.render,e.status,e.renderData);if(e.status)return l(e.status);if(e.sendStatus)return l(e.sendStatus);throw new Error(`Invalid ${t} input`)},h=e=>{if(e&&!u[e])throw new Error(`Model ${e} is not set`);return u[e||"_default"]},f=(e,t,s)=>{const i={...h(e)};return i[s]={...i[s],...t},o(n,i),i},p=async(e,t)=>async function(){if(this.deserializedUser)return this.deserializedUser;const e=t(this.hadrian.user);return this.deserializedUser=e,e},y=()=>function(){return Promise.resolve(this.deserializedUser)},w=async(e,t,n)=>{const s=await t(e);return n.deserializedUser=s,s},b=e=>e,S=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"init");if(!n.sessions.useSessions)return(e=>{if(e.init.onSuccess){const t=d(e.init.onSuccess,"init.onSuccess");return(e,n,s)=>{e.hadrian={isAuthenticated:!1},t(e,n,s)}}return(e,t,n)=>{e.hadrian={isAuthenticated:!1,auth:{}},n()}})(n);const{deserialize:s,deserializeTactic:i}=n.sessions,r=d(n.init.onError,"init.onError"),a="always"===i?w:p,o=(e,t,n)=>{e.session.hadrian?(e.hadrian=e.session.hadrian,e.deserializedUser=null,e.hadrian.user?a(e.hadrian.user,s,e).then(t=>{e.user=t,n()}).catch(s=>{r(e,t,n,s)}):n()):(e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n())};return n.init.onSuccess?[o,d(n.init.onSuccess,"init.onSuccess")]:o};class j extends Error{constructor(e){super(e),this.name="ValidationError",this.reason=e,this.isFail=!0}}exports.Fail=j,exports.authenticate=(e,t)=>{"object"==typeof e&&(t=e,e="_default");const n=f(e,t,"authenticate"),{clientType:s,name:i}=n,{verify:r,getData:a,setUser:o}=n.authenticate,c=(e=>"function"==typeof e?e:t=>t[e])(n.authenticate.extract),u=d(n.authenticate.onError,"authenticate.onError"),l=d(n.authenticate.onFail,"authenticate.onFail"),h="always"===n.sessions.deserializeTactic?b:y,p=(e,t,n)=>{(async()=>{const u=await c(e),d=await a(u,e),f=await r(u,d,e);if(!f)return l(e,t,n);const p=await o(u,d,e);e.hadrian.auth[i]={clientType:s,query:u,model:i,result:f},e.hadrian.isAuthenticated=!0,e.deserializedUser=p,e.user=h(p,e),n()})().catch(s=>{if(s.isFail)return l(e,t,n,s);u(e,t,n,s)})},w=[];return n.authenticate.selfInit&&w.push(S(n.init)),w.push(p),n.sessions.useSessions&&w.push(((e,t)=>{const{serialize:n}=e.sessions;return(e,s,i)=>{(async()=>{const t=await n(e.deserializedUser);e.hadrian.user=t,e.session.hadrian=e.hadrian,i()})().catch(n=>t(e,s,i,n))}})(n,u)),n.authenticate.onSuccess&&w.push(d(n.authenticate.onSuccess,"authenticate.onSuccess")),1===w.length?p:w},exports.checkAuthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"checkAuthenticated").checkAuthenticated,s=d(n.onFail,"checkAuthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(e.hadrian.isAuthenticated)return n();s(e,t)};const i=d(n.onSuccess,"checkAuthenticated.onSuccess");return(e,t,n)=>{if(e.hadrian.isAuthenticated)return i(e,t,n);s(e,t)}},exports.checkUnauthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"checkUnauthenticated").checkUnauthenticated,s=d(n.onFail,"checkUnauthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return n();s(e,t)};const i=d(n.onSuccess,"checkUnauthenticated.onSuccess");return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return i(e,t,n);s(e,t)}},exports.defineModel=(e,t,n)=>{if("object"==typeof e){if(n=t,!(t=e).name)throw new Error("Model must have a name");e=e.name}Object.keys(u).length<2&&!1!==n&&(n=!0),u[e]=c(t),u[e].name=e,u[e].isDefault=n,n&&(u._default=u[e])},exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const{onError:n,onSuccess:s}=f(e,t,"deserializeUser").deserializeUser,i=d(n,"deserializeUserOnError"),r=(e,t,n)=>{if(!e.user)return n();e.user().then(()=>{n()}).catch(s=>{i(e,t,n,s)})};return s?[r,d(s,"deserializeUser.onSuccess")]:r},exports.init=S,exports.initialize=S,exports.logout=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"logout");if(!n.sessions.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const s=(e,t,n)=>{delete e.user,e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n()};return n.logout.onSuccess?[s,d(n.logout.onSuccess,"logoutOnSuccess")]:s},exports.models=u,exports.modifyModel=(e,t)=>{if(!u[e])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:n}=u[e];Object.assign(u[e],t),u[e].isDefault=n};
