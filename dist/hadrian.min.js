"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=(e,t,s,n)=>s(n||new Error("Server Error")),t={sendStatus:401},s=()=>({name:"_default",clientType:"client",sessions:{useSessions:!1,deserializeTactic:"always",serialize:e=>e,deserialize:e=>e},authenticate:{extract:"body",getData:()=>({}),verify:()=>!0,setUser:(e,t)=>t,onError:e,onFail:t,onSuccess:null,selfInit:!1},init:{onError:e,onSuccess:null},checkAuthenticated:{onFail:t,onSuccess:null},checkUnauthenticated:{onFail:t,onSuccess:null},logout:{onSuccess:null},deserializeUser:{onError:e,onSuccess:null}}),n={_default:s()},r=e=>"object"==typeof e&&null!==e&&!Array.isArray(e),i=(e,t,s=0)=>(Object.keys(t).forEach(n=>{if(void 0===e[n])throw new Error("Unknown option "+n);r(e[n])&&r(t[n])&&s>0?i(e[n],t[n],s-1):e[n]=t[n]}),e),a=e=>(t,s)=>s.sendStatus(e),o=(e,t)=>{if("function"==typeof e)return e;if("object"!=typeof e)throw new Error(`Invalid ${t} input, type ${typeof e} - ${e}`);if(e.redirect)return s=e.redirect,(n=e.status)?(e,t)=>t.status(n).redirect(s):(e,t)=>t.redirect(s);var s,n;if(e.send)return((e,t)=>t?(s,n)=>n.status(t).send(e):(t,s)=>s.send(e))(e.send,e.status);if(e.json)return((e,t)=>t?(s,n)=>n.status(t).json(e):(t,s)=>s.json(e))(e.json,e.status);if(e.render)return((e,t,s={})=>t?(n,r)=>r.status(t).render(e,s):(t,n)=>n.render(e,s))(e.render,e.status,e.renderData);if(e.status)return a(e.status);if(e.sendStatus)return a(e.sendStatus);throw new Error(`Invalid ${t} input`)},c=e=>{if(e&&!n[e])throw new Error("model is not set");return n[e||"_default"]},u=(e,t,s)=>{const n={...c(e)};return n[s]={...n[s],...t},(e=>{if("function"!=typeof e.authenticate.verify)throw new Error("verify must be a function");if("function"!=typeof e.authenticate.getData)throw new Error("getUser must be a function")})(n),n},d=async(e,t)=>async function(){if(this.deserializedUser)return this.deserializedUser;const e=t(this.hadrian.user);return this.deserializedUser=e,e},h=()=>function(){return Promise.resolve(this.deserializedUser)},l=async(e,t,s)=>{const n=await t(e);return s.deserializedUser=n,n},f=e=>e,p=(e,t)=>{"object"==typeof e&&(t=e,e=null);const s=u(e,t,"init");if(!s.sessions.useSessions)return(e=>{if(e.init.onSuccess){const t=o(e.init.onSuccess,"init.onSuccess");return(e,s,n)=>{e.hadrian={isAuthenticated:!1},t(e,s,n)}}return(e,t,s)=>{e.hadrian={isAuthenticated:!1,auth:{}},s()}})(s);const{deserialize:n,deserializeTactic:r}=s.sessions,i=o(s.init.onError,"init.onError"),a="always"===r?l:d,c=(e,t,s)=>{e.session.hadrian?(e.hadrian=e.session.hadrian,e.deserializedUser=null,e.hadrian.user?a(e.hadrian.user,n,e).then(t=>{e.user=t,s()}).catch(n=>{i(e,t,s,n)}):s()):(e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,s())};return s.init.onSuccess?[c,o(s.init.onSuccess,"init.onSuccess")]:c};class y extends Error{constructor(e){super(e),this.name="ValidationError",this.reason=e,this.isFail=!0}}exports.Fail=y,exports.authenticate=(e,t)=>{"object"==typeof e&&(t=e,e=null);const s=u(e,t,"authenticate"),{clientType:n,name:r}=s,{verify:i,getData:a,setUser:c}=s.authenticate,d=(e=>"function"==typeof e?e:t=>t[e])(s.authenticate.extract),l=o(s.authenticate.onError,"authenticate.onError"),y=o(s.authenticate.onFail,"authenticate.onFail"),S="always"===s.sessions.deserializeTactic?f:h,w=(e,t,s)=>{(async()=>{const o=await d(e),u=await a(o,e),h=await i(o,u,e);if(!h)return y(e,t,s);const l=await c(o,u,e);e.hadrian.auth[r]={clientType:n,query:o,model:r,result:h},e.hadrian.isAuthenticated=!0,e.deserializedUser=l,e.user=S(l,e),s()})().catch(n=>{if(n.isFail)return y(e,t,s,n);l(e,t,s,n)})},U=[];return s.authenticate.selfInit&&U.push(p(s)),U.push(w),s.sessions.useSessions&&U.push(((e,t)=>{const{serialize:s}=e.sessions;return(e,n,r)=>{(async()=>{const t=await s(e.deserializedUser);e.hadrian.user=t,e.session.hadrian=e.hadrian,r()})().catch(s=>t(e,n,r,s))}})(s,l)),s.authenticate.onSuccess&&U.push(o(s.authenticate.onSuccess,"authenticate.onSuccess")),1===U.length?w:U},exports.checkAuthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const s=u(e,t,"checkAuthenticated").checkAuthenticated,n=o(s.onFail,"checkAuthenticated.OnFail");if(!s.onSuccess)return(e,t,s)=>{if(e.hadrian.isAuthenticated)return s();n(e,t)};const r=o(s.onSuccess,"checkAuthenticated.onSuccess");return(e,t,s)=>{if(e.hadrian.isAuthenticated)return r(e,t,s);n(e,t)}},exports.checkUnauthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const s=u(e,t,"checkUnauthenticated").checkUnauthenticated,n=o(s.onFail,"checkUnauthenticated.OnFail");if(!s.onSuccess)return(e,t,s)=>{if(!e.hadrian.isAuthenticated)return s();n(e,t)};const r=o(s.onSuccess,"checkUnauthenticated.onSuccess");return(e,t,s)=>{if(!e.hadrian.isAuthenticated)return r(e,t,s);n(e,t)}},exports.defineModel=(e,t,r)=>{if("object"==typeof e){if(r=t,!(t=e).name)throw new Error("Model must have a name");e=e.name}n.length<2&&!1!==r&&(r=!0),n[e]=i(s(),t,1),n[e].name=e,n[e].isDefault=r,r&&(n._default=n[e])},exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const{onError:s,onSuccess:n}=u(e,t,"deserializeUser").deserializeUser,r=o(s,"deserializeUserOnError"),i=(e,t,s)=>{if(!e.user)return s();e.user().then(()=>{s()}).catch(n=>{r(e,t,s,n)})};return n?[i,o(n,"deserializeUser.onSuccess")]:i},exports.init=p,exports.initialize=p,exports.logout=(e,t)=>{"object"==typeof e&&(t=e,e=null);const s=u(e,t,"logout");if(!s.sessions.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const n=(e,t,s)=>{delete e.user,e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,s()};return s.logout.onSuccess?[n,o(s.logout.onSuccess,"logoutOnSuccess")]:n},exports.models=n,exports.modifyModel=(e,t)=>{if(!n[e])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:s}=n[e];Object.assign(n[e],t),n[e].isDefault=s};
