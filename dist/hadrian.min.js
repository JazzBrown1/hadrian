"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=(e,t,n,s)=>n(s||new Error("Server Error")),t={sendStatus:401},n={name:{type:["string"],default:"_default"},clientType:{type:["string"],default:"client"},isDefault:{type:["boolean","undefined"],default:!1},sessions:{type:"child",children:{useSessions:{type:["boolean"],default:!1},deserializeTactic:{type:["string"],default:"always"},serialize:{type:["function"],default:e=>e},deserialize:{type:["function"],default:e=>e}}},authenticate:{type:"child",children:{extract:{type:["string","function"],default:"body"},getData:{type:["function"],default:()=>({})},verify:{type:["function"],default:()=>!0},setUser:{type:["function"],default:(e,t)=>t},onError:{type:["null","function","object"],default:e},onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null},selfInit:{type:["boolean"],default:!1}}},init:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}},checkAuthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},checkUnauthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},logout:{type:"child",children:{onSuccess:{type:["null","function","object"],default:null}}},deserializeUser:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}}},s=e=>{const t=typeof e;return"object"!==t?t:null===e?"null":Array.isArray(e)?"array":"object"},i=(e,t,n)=>`${e.join(".")}.${t} is of type ${s(n[t].default)}, must be of the following type/s: ${n[t].type}`,r=(e,t)=>e.type.includes(s(t)),a=(e,t={},n=[])=>(Object.keys(t).forEach(s=>{if(void 0===e[s])throw new Error(((e,t)=>`Unknown option ${e.join(".")}.${t}`)(n,s));"child"===e[s].type&&a(e[s].children,t[s],[...n,s])}),t),c=(e,t={},n={})=>{const s=(e,t,n,a)=>(Object.keys(e).forEach(c=>{if("child"===e[c].type)t[c]||(t[c]={}),s(e[c].children,t[c],n[c]||{},[...a,c]);else if(n[c]){if(!r(e[c],n[c]))throw new Error(i(a,c,e));t[c]=n[c]}else if(t[c]){if(!r(e[c],t[c]))throw new Error(i(a,c,e))}else t[c]=e[c].default}),t);return a(e,t),a(e,n),s(e,t,n,[])},o=(e,t)=>c(n,e,t),u={_default:c(n)},l=e=>(t,n)=>n.sendStatus(e),d=(e,t)=>{if("function"==typeof e)return e;if(e.redirect)return n=e.redirect,(s=e.status)?(e,t)=>t.status(s).redirect(n):(e,t)=>t.redirect(n);var n,s;if(e.send)return((e,t)=>t?(n,s)=>s.status(t).send(e):(t,n)=>n.send(e))(e.send,e.status);if(e.json)return((e,t)=>t?(n,s)=>s.status(t).json(e):(t,n)=>n.json(e))(e.json,e.status);if(e.render)return((e,t,n={})=>t?(s,i)=>i.status(t).render(e,n):(t,s)=>s.render(e,n))(e.render,e.status,e.renderData);if(e.status)return l(e.status);if(e.sendStatus)return l(e.sendStatus);throw new Error(`Invalid ${t} input`)},h=(e,t,n)=>o((e=>{if(e&&!u[e])throw new Error(`Model ${e} is not set`);return u[e||"_default"]})(e),{[n]:t}),f=async(e,t)=>async function(){if(this.deserializedUser)return this.deserializedUser;const e=t(this.hadrian.user);return this.deserializedUser=e,e},y=()=>function(){return Promise.resolve(this.deserializedUser)},p=async(e,t,n)=>{const s=await t(e);return n.deserializedUser=s,s},S=e=>e,j=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=h(e,t,"init");if(!n.sessions.useSessions)return(e=>{if(e.init.onSuccess){const t=d(e.init.onSuccess,"init.onSuccess");return(e,n,s)=>{e.hadrian={isAuthenticated:!1},t(e,n,s)}}return(e,t,n)=>{e.hadrian={isAuthenticated:!1,auth:{}},n()}})(n);const{deserialize:s,deserializeTactic:i}=n.sessions,r=d(n.init.onError,"init.onError"),a="always"===i?p:f,c=(e,t,n)=>{e.session.hadrian?(e.hadrian=e.session.hadrian,e.deserializedUser=null,e.hadrian.user?a(e.hadrian.user,s,e).then(t=>{e.user=t,n()}).catch(s=>{r(e,t,n,s)}):n()):(e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n())};return n.init.onSuccess?[c,d(n.init.onSuccess,"init.onSuccess")]:c};class b extends Error{constructor(e){super(e),this.name="ValidationError",this.reason=e,this.isFail=!0}}exports.Fail=b,exports.authenticate=(e,t)=>{"object"==typeof e&&(t=e,e="_default");const n=h(e,t,"authenticate"),{clientType:s,name:i}=n,{verify:r,getData:a,setUser:c}=n.authenticate,o=(e=>"function"==typeof e?e:t=>t[e])(n.authenticate.extract),u=d(n.authenticate.onError,"authenticate.onError"),l=d(n.authenticate.onFail,"authenticate.onFail"),f="always"===n.sessions.deserializeTactic?S:y,p=(e,t,n)=>{(async()=>{const u=await o(e),d=await a(u,e),h=await r(u,d,e);if(!h)return l(e,t,n);const y=await c(u,d,e);e.hadrian.auth[i]={clientType:s,query:u,model:i,result:h},e.hadrian.isAuthenticated=!0,e.deserializedUser=y,e.user=f(y,e),n()})().catch(s=>{if(s.isFail)return l(e,t,n,s);u(e,t,n,s)})},b=[];return n.authenticate.selfInit&&b.push(j(n.init)),b.push(p),n.sessions.useSessions&&b.push(((e,t)=>{const{serialize:n}=e.sessions;return(e,s,i)=>{(async()=>{const t=await n(e.deserializedUser);e.hadrian.user=t,e.session.hadrian=e.hadrian,i()})().catch(n=>t(e,s,i,n))}})(n,u)),n.authenticate.onSuccess&&b.push(d(n.authenticate.onSuccess,"authenticate.onSuccess")),1===b.length?p:b},exports.checkAuthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=h(e,t,"checkAuthenticated").checkAuthenticated,s=d(n.onFail,"checkAuthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(e.hadrian.isAuthenticated)return n();s(e,t)};const i=d(n.onSuccess,"checkAuthenticated.onSuccess");return(e,t,n)=>{if(e.hadrian.isAuthenticated)return i(e,t,n);s(e,t)}},exports.checkUnauthenticated=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=h(e,t,"checkUnauthenticated").checkUnauthenticated,s=d(n.onFail,"checkUnauthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return n();s(e,t)};const i=d(n.onSuccess,"checkUnauthenticated.onSuccess");return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return i(e,t,n);s(e,t)}},exports.defineModel=(e,t,n)=>{if("object"==typeof e){if(n=t,!(t=e).name)throw new Error("Model must have a name");e=e.name}Object.keys(u).length<2&&!1!==n&&(n=!0),u[e]=o(t),u[e].name=e,u[e].isDefault=n,n&&(u._default=u[e])},exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const{onError:n,onSuccess:s}=h(e,t,"deserializeUser").deserializeUser,i=d(n,"deserializeUserOnError"),r=(e,t,n)=>{if(!e.user)return n();e.user().then(()=>{n()}).catch(s=>{i(e,t,n,s)})};return s?[r,d(s,"deserializeUser.onSuccess")]:r},exports.init=j,exports.initialize=j,exports.logout=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=h(e,t,"logout");if(!n.sessions.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const s=(e,t,n)=>{delete e.user,e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n()};return n.logout.onSuccess?[s,d(n.logout.onSuccess,"logoutOnSuccess")]:s},exports.models=u,exports.modifyModel=(e,t)=>{if(!u[e])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:n}=u[e];Object.assign(u[e],t),u[e].isDefault=n};
