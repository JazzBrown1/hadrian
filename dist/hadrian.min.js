"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=(e,t,n,i)=>n(i||new Error("Server Error")),t={sendStatus:401},n={name:{type:["string"],default:"_default"},clientType:{type:["string"],default:"client"},isDefault:{type:["boolean","undefined"],default:!1},sessions:{type:"child",children:{useSessions:{type:["boolean"],default:!1},deserializeTactic:{type:["string"],default:"always"},serialize:{type:["function"],default:e=>e},deserialize:{type:["function"],default:e=>e}}},authenticate:{type:"child",children:{extract:{type:["string","function"],default:"body"},getData:{type:["function"],default:()=>({})},verify:{type:["function"],default:()=>!0},setUser:{type:["function"],default:(e,t)=>t},onError:{type:["null","function","object"],default:e},onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null},selfInit:{type:["boolean"],default:!1}}},init:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}},checkAuthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},checkUnauthenticated:{type:"child",children:{onFail:{type:["null","function","object"],default:t},onSuccess:{type:["null","function","object"],default:null}}},logout:{type:"child",children:{onSuccess:{type:["null","function","object"],default:null}}},deserializeUser:{type:"child",children:{onError:{type:["null","function","object"],default:e},onSuccess:{type:["null","function","object"],default:null}}}},i=e=>{const t=typeof e;return"object"!==t?t:null===e?"null":Array.isArray(e)?"array":"object"},s=(e,t,n)=>`${e.join(".")}.${t} is of type ${i(n[t].default)}, must be of the following type/s: ${n[t].type}`,r=(e,t)=>e.type.includes(i(t)),a=(e,t={},n=[])=>(Object.keys(t).forEach(i=>{if(void 0===e[i])throw new Error(((e,t)=>`Unknown option ${e.join(".")}.${t}`)(n,i));"child"===e[i].type&&a(e[i].children,t[i],[...n,i])}),t),o=(e,t={},n={})=>{const i=(e,t,n,a)=>(Object.keys(e).forEach(o=>{if("child"===e[o].type)t[o]||(t[o]={}),i(e[o].children,t[o],n[o]||{},[...a,o]);else if(n[o]){if(!r(e[o],n[o]))throw new Error(s(a,o,e));t[o]=n[o]}else if(t[o]){if(!r(e[o],t[o]))throw new Error(s(a,o,e))}else t[o]=e[o].default}),t);return a(e,t),a(e,n),i(e,t,n,[])},u=(e,t)=>o(n,e,t),c={_default:o(n)},l=(e,t,n)=>{if("object"==typeof e){if(n=t,!(t=e).name)throw new Error("Model must have a name");e=e.name}Object.keys(c).length<2&&!1!==n&&(n=!0),c[e]=u(t),c[e].name=e,c[e].isDefault=n,n&&(c._default=c[e])},d=e=>(t,n)=>n.sendStatus(e),h=(e,t)=>{if("function"==typeof e)return e;if(e.redirect)return n=e.redirect,(i=e.status)?(e,t)=>t.status(i).redirect(n):(e,t)=>t.redirect(n);var n,i;if(e.send)return((e,t)=>t?(n,i)=>i.status(t).send(e):(t,n)=>n.send(e))(e.send,e.status);if(e.json)return((e,t)=>t?(n,i)=>i.status(t).json(e):(t,n)=>n.json(e))(e.json,e.status);if(e.render)return((e,t,n={})=>t?(i,s)=>s.status(t).render(e,n):(t,i)=>i.render(e,n))(e.render,e.status,e.renderData);if(e.status)return d(e.status);if(e.sendStatus)return d(e.sendStatus);throw new Error(`Invalid ${t} input`)},f=(e,t,n)=>u((e=>{if(e&&!c[e])throw new Error(`Model ${e} is not set`);return c[e||"_default"]})(e),{[n]:t}),p=async(e,t,n)=>async function(){if(n.deserializedUser)return n.deserializedUser;const e=t(n.hadrian.user);return n.deserializedUser=e,e},y=()=>function(){return Promise.resolve(this.deserializedUser)},b=async(e,t,n)=>{const i=await t(e);return n.deserializedUser=i,i},S=e=>e,j=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"init");if(!n.sessions.useSessions)return(e=>{if(e.init.onSuccess){const t=h(e.init.onSuccess,"init.onSuccess");return(e,n,i)=>{e.hadrian={isAuthenticated:!1},t(e,n,i)}}return(e,t,n)=>{e.hadrian={isAuthenticated:!1,auth:{}},n()}})(n);const{deserialize:i,deserializeTactic:s}=n.sessions,r=h(n.init.onError,"init.onError"),a="always"===s?b:p,o=(e,t,n)=>{e.session.hadrian?(e.hadrian=e.session.hadrian,e.deserializedUser=null,e.hadrian.user?a(e.hadrian.user,i,e).then(t=>{e.user=t,n()}).catch(i=>{r(e,t,n,i)}):n()):(e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n())};return n.init.onSuccess?[o,h(n.init.onSuccess,"init.onSuccess")]:o},w=(e,t)=>{"object"==typeof e&&(t=e,e="_default");const n=f(e,t,"authenticate"),{clientType:i,name:s}=n,{verify:r,getData:a,setUser:o}=n.authenticate,u=(e=>"function"==typeof e?e:t=>t[e])(n.authenticate.extract),c=h(n.authenticate.onError,"authenticate.onError"),l=h(n.authenticate.onFail,"authenticate.onFail"),d="always"===n.sessions.deserializeTactic?S:y,p=(e,t,n)=>{(async()=>{const c=await u(e),h=await a(c,e),f=await r(c,h,e);if(!f)return l(e,t,n);const p=await o(c,h,e);e.hadrian.auth[s]={clientType:i,query:c,model:s,result:f},e.hadrian.isAuthenticated=!0,e.deserializedUser=p,e.user=d(p,e),n()})().catch(i=>{if(i.isFail)return l(e,t,n,i);c(e,t,n,i)})},b=[];return n.authenticate.selfInit&&b.push(j(e,{onError:n.onError})),b.push(p),n.sessions.useSessions&&b.push(((e,t)=>{const{serialize:n}=e.sessions;return(e,i,s)=>{(async()=>{const t=await n(e.deserializedUser);e.hadrian.user=t,e.session.hadrian=e.hadrian,s()})().catch(n=>t(e,i,s,n))}})(n,c)),n.authenticate.onSuccess&&b.push(h(n.authenticate.onSuccess,"authenticate.onSuccess")),1===b.length?p:b},m=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"checkUnauthenticated").checkUnauthenticated,i=h(n.onFail,"checkUnauthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return n();i(e,t)};const s=h(n.onSuccess,"checkUnauthenticated.onSuccess");return(e,t,n)=>{if(!e.hadrian.isAuthenticated)return s(e,t,n);i(e,t)}},E=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"checkAuthenticated").checkAuthenticated,i=h(n.onFail,"checkAuthenticated.OnFail");if(!n.onSuccess)return(e,t,n)=>{if(e.hadrian.isAuthenticated)return n();i(e,t)};const s=h(n.onSuccess,"checkAuthenticated.onSuccess");return(e,t,n)=>{if(e.hadrian.isAuthenticated)return s(e,t,n);i(e,t)}},U=(e,t)=>{"object"==typeof e&&(t=e,e=null);const n=f(e,t,"logout");if(!n.sessions.useSessions)throw new Error("Cannot use Logout middleware when use sessions set false in model");const i=(e,t,n)=>{delete e.user,e.hadrian={isAuthenticated:!1,auth:{}},e.session.hadrian=e.hadrian,n()};return n.logout.onSuccess?[i,h(n.logout.onSuccess,"logoutOnSuccess")]:i};class z extends Error{constructor(e){super(e),this.name="ValidationError",this.reason=e,this.isFail=!0}}exports.Fail=z,exports.Model=function(e,t){this.name=t||e.name,l(this.name,e),this.options=e,this.init=function(e){return j(this.name,e)}.bind(this),this.authenticate=function(e){return w(this.name,e)}.bind(this),this.checkAuthenticated=function(e){return E(this.name,e)}.bind(this),this.checkUnauthenticated=function(e){return m(this.name,e)}.bind(this),this.logout=function(e){return U(this.name,e)}.bind(this)},exports.authenticate=w,exports.checkAuthenticated=E,exports.checkUnauthenticated=m,exports.defineModel=l,exports.deserializeUser=(e,t)=>{"object"==typeof e&&(t=e,e=null);const{onError:n,onSuccess:i}=f(e,t,"deserializeUser").deserializeUser,s=h(n,"deserializeUserOnError"),r=(e,t,n)=>{if(!e.user)return n();e.user().then(()=>{n()}).catch(i=>{s(e,t,n,i)})};return i?[r,h(i,"deserializeUser.onSuccess")]:r},exports.init=j,exports.initialize=j,exports.logout=U,exports.models=c,exports.modifyModel=(e,t)=>{if(!c[e])throw new Error("Cannot modifyModel a model that is not set");const{isDefault:n}=c[e];Object.assign(c[e],t),c[e].isDefault=n};
